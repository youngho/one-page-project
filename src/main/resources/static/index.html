<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Page Project</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.9/asciidoctor.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236366f1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>

<body class="m-0 p-0 overflow-x-hidden bg-gradient-to-br from-slate-800 via-slate-700 to-slate-900 font-sans min-h-screen">
    <div id="app">
        <!-- Project Selector -->
        <div class="fixed left-6 top-6 z-[1000] animate-fade-in">
            <div class="glass rounded-2xl shadow-2xl p-5 min-w-[320px] border border-white/20">
                <div class="flex items-center gap-2">
                    <select v-model="selectedProject"
                        @change="projectClick(selectedProject)"
                        class="flex-1 px-4 py-3 bg-white/80 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all cursor-pointer hover:bg-white">
                        <option v-for="(project, projectId) in projects" 
                            :key="projectId"
                            :value="projectId">
                            {{ project.title }}
                        </option>
                        <option v-if="Object.keys(projects).length === 0" value="" disabled>
                            ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§
                        </option>
                    </select>
                    <button @click="projectAddModal"
                        class="px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl text-sm font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all whitespace-nowrap shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <span class="text-xs opacity-90 mr-1">({{ totalProjectCount }})</span>+
                    </button>
                </div>
            </div>
        </div>

        <!-- User Panel -->
        <div class="fixed bottom-6 left-6 z-[1000] animate-fade-in">
            <div class="glass rounded-2xl shadow-2xl p-5 border border-white/20">
                <!-- Î°úÍ∑∏Ïù∏ Ï†Ñ: ÏÇ¨Ïö©ÏûêÎ™Ö ÏûÖÎ†• Î∞è Î°úÎìú -->
                <div v-if="!currentUser" class="flex items-center gap-2">
                    <input type="text" 
                        v-model="usernameInput" 
                        placeholder="ÏÇ¨Ïö©ÏûêÎ™Ö ÏûÖÎ†•" 
                        @keyup.enter="loadUserProjects"
                        class="px-4 py-2.5 bg-white/80 border border-gray-200 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all w-40">
                    <button @click="loadUserProjects"
                        class="px-5 py-2.5 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl text-sm font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        Î°úÎìú
                    </button>
                </div>
                <!-- Î°úÍ∑∏Ïù∏ ÌõÑ: ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î∞è Î°úÍ∑∏ÏïÑÏõÉ -->
                <div v-else class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                            <span class="text-white text-sm">üë§</span>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">{{ currentUser }}</span>
                    </div>
                    <button @click="logout"
                        class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-semibold hover:bg-red-600 transition-all shadow-md hover:shadow-lg">
                        Î°úÍ∑∏ÏïÑÏõÉ
                    </button>
                </div>
            </div>
        </div>

        <!-- Project View -->
        <div class="w-screen h-screen overflow-hidden relative">
            <div class="absolute w-[200%] h-[200%] top-1/2 left-1/2 origin-center transition-transform duration-100"
                :style="canvasStyle">
                <project-item v-if="selectedProject && projects[selectedProject]" 
                    :key="selectedProject"
                    :project="projects[selectedProject]" 
                    :project-id="selectedProject"
                    @edit="projectEditModal" 
                    @delete="deleteProject"
                    @update="updateProject" />
            </div>
        </div>

        <!-- Modal -->
        <project-modal v-if="isProjectModalOpen" 
            :project="editingProject" 
            :is-editing="!!currentEditingProjectId"
            @close="closeModal" 
            @save="saveProject" 
            @delete="deleteProject(currentEditingProjectId)" />
    </div>

    <script>
        const { createApp, ref, reactive, computed, nextTick } = Vue;
        const asciidoctor = Asciidoctor();

        const ProjectItem = {
            props: {
                project: Object,
                projectId: String
            },
            emits: ['edit', 'delete', 'update'],
            setup(props, { emit }) {
                const { ref, nextTick } = Vue;
                const isEditingDesc = ref(false);
                const editingDesc = ref('');
                const descHeight = ref('auto');
                const descRef = ref(null);

                const renderedDesc = computed(() => {
                    if (!props.project.desc) return '';
                    return asciidoctor.convert(props.project.desc, { 
                        safe: 'safe', 
                        attributes: { showtitle: false } 
                    });
                });

                const startEditing = () => {
                    if (descRef.value) {
                        descHeight.value = descRef.value.offsetHeight + 'px';
                    }
                    isEditingDesc.value = true;
                    editingDesc.value = props.project.desc || '';
                    nextTick(() => {
                        const textarea = document.querySelector('.desc-textarea');
                        if (textarea) {
                            textarea.style.height = descHeight.value;
                            textarea.focus();
                            textarea.select();
                        }
                    });
                };

                const saveDesc = () => {
                    if (editingDesc.value !== props.project.desc) {
                        emit('update', {
                            ...props.project,
                            desc: editingDesc.value
                        });
                    }
                    isEditingDesc.value = false;
                };

                const cancelEditing = () => {
                    editingDesc.value = props.project.desc || '';
                    isEditingDesc.value = false;
                };

                const handleKeydown = (e) => {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        saveDesc();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEditing();
                    }
                };

                return { 
                    renderedDesc, 
                    isEditingDesc, 
                    editingDesc, 
                    descHeight,
                    descRef,
                    startEditing, 
                    saveDesc, 
                    cancelEditing,
                    handleKeydown
                };
            },
            template: `
                <div class="absolute bg-stone-50 rounded-3xl p-10 shadow-2xl transition-all duration-300 select-none group border-2 border-stone-200"
                    :style="{ left: '50%', top: '50%', transform: 'translate(-50%, -50%)', width: '95vw', maxWidth: '95vw' }">
                    <div class="mb-6">
                        <h2 class="text-stone-800 mb-2 text-2xl font-bold leading-tight">{{ project.title }}</h2>
                        <div class="h-1 w-16 bg-gradient-to-r from-stone-400 to-stone-500 rounded-full"></div>
                    </div>
                    <div v-if="!isEditingDesc" 
                        ref="descRef"
                        @dblclick="startEditing"
                        class="text-stone-700 leading-relaxed mb-6 prose prose-sm max-w-none cursor-text hover:bg-stone-100/50 rounded-lg p-2 -m-2 transition-colors"
                        v-html="renderedDesc"></div>
                    <div v-else class="mb-6">
                        <textarea 
                            v-model="editingDesc"
                            @blur="saveDesc"
                            @keydown="handleKeydown"
                            :style="{ height: descHeight }"
                            class="desc-textarea w-full px-4 py-3 bg-white border-2 border-stone-300 rounded-xl font-sans text-sm resize-none focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-stone-500 transition-all"
                            placeholder="ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (AsciiDoc ÌòïÏãù ÏßÄÏõê)"></textarea>
                        <div class="mt-2 text-xs text-stone-500">
                            Ctrl/Cmd + Enter: Ï†ÄÏû• | ESC: Ï∑®ÏÜå
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-6">
                        <span v-for="tag in project.tags" 
                            :key="tag" 
                            class="inline-block bg-stone-100 px-3 py-1.5 rounded-full text-xs font-medium text-stone-700 border border-stone-300">
                            {{ tag }}
                        </span>
                    </div>
                    <div class="flex gap-2.5 mt-6 opacity-0 transition-opacity duration-300 group-hover:opacity-100 justify-end">
                        <button @click.stop="$emit('edit', projectId)"
                            class="px-3 py-1.5 bg-gradient-to-r from-stone-500 to-stone-600 text-white border-none rounded-lg cursor-pointer text-xs font-semibold transition-all hover:from-stone-600 hover:to-stone-700 hover:-translate-y-0.5 hover:shadow-lg">
                            ‚úèÔ∏è Ìé∏Ïßë
                        </button>
                    </div>
                </div>
            `
        };

        const ProjectModal = {
            props: {
                project: Object,
                isEditing: Boolean
            },
            emits: ['close', 'save', 'delete'],
            setup(props, { emit }) {
                const form = reactive({
                    title: props.project?.title || '',
                    desc: props.project?.desc || '',
                    tags: props.project?.tags?.join(', ') || ''
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    const tags = form.tags.split(',').map(t => t.trim()).filter(t => t);
                    emit('save', {
                        title: form.title,
                        desc: form.desc,
                        tags
                    });
                };

                return { form, handleSubmit };
            },
            template: `
                <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[2000] flex items-center justify-center p-4 animate-fade-in"
                    @click.self="$emit('close')">
                    <div class="glass rounded-3xl p-8 w-full max-w-lg shadow-2xl border border-white/20 animate-fade-in">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
                                {{ isEditing ? 'ÌîÑÎ°úÏ†ùÌä∏ Ìé∏Ïßë' : 'ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä' }}
                            </h2>
                            <div class="h-1 w-20 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full"></div>
                        </div>
                        <form @submit="handleSubmit">
                            <div class="mb-5">
                                <label class="block mb-2 text-sm font-semibold text-gray-700">Ï†úÎ™© (Ïù¥Î™®ÏßÄ Ìè¨Ìï®)</label>
                                <input type="text" 
                                    v-model="form.title" 
                                    required
                                    class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-xl font-sans text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                            </div>
                            <div class="mb-5">
                                <label class="block mb-2 text-sm font-semibold text-gray-700">ÏÑ§Î™Ö</label>
                                <textarea v-model="form.desc" 
                                    required
                                    class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-xl font-sans text-sm resize-y min-h-24 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"></textarea>
                            </div>
                            <div class="mb-6">
                                <label class="block mb-2 text-sm font-semibold text-gray-700">ÌÉúÍ∑∏ (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)</label>
                                <input type="text" 
                                    v-model="form.tags" 
                                    placeholder="React, Node.js, MongoDB"
                                    class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-xl font-sans text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button type="submit"
                                    class="flex-1 py-3.5 border-none rounded-xl cursor-pointer text-sm font-semibold transition-all hover:-translate-y-0.5 hover:shadow-xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white hover:from-indigo-600 hover:to-purple-700">
                                    Ï†ÄÏû•
                                </button>
                                <button type="button" 
                                    @click="$emit('close')"
                                    class="flex-1 py-3.5 border-none rounded-xl cursor-pointer text-sm font-semibold transition-all hover:-translate-y-0.5 hover:shadow-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
                                    Ï∑®ÏÜå
                                </button>
                            </div>
                            <div v-if="isEditing" class="mt-4">
                                <button type="button"
                                    @click="$emit('delete')"
                                    class="w-full py-3 border-none rounded-xl cursor-pointer text-sm font-semibold transition-all hover:-translate-y-0.5 hover:shadow-lg bg-red-50 text-red-600 hover:bg-red-100 border border-red-200">
                                    üóëÔ∏è ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `
        };

        const app = createApp({
            components: {
                'project-item': ProjectItem,
                'project-modal': ProjectModal
            },
            setup() {
                const projects = reactive({});
                const selectedProject = ref(null);
                const currentUser = ref('');
                const usernameInput = ref('');
                const isProjectModalOpen = ref(false);
                const currentEditingProjectId = ref(null);
                const API_BASE_URL = 'http://localhost:8080/api/projects';

                const canvasStyle = computed(() => ({
                    transform: 'translate(-50%, -50%) scale(1)'
                }));

                const editingProject = computed(() => {
                    if (!currentEditingProjectId.value) return null;
                    return projects[currentEditingProjectId.value] || null;
                });

                const totalProjectCount = computed(() => {
                    return Object.keys(projects).length;
                });

                const projectClick = (projectId) => {
                    selectedProject.value = projectId;
                };

                const saveProjectToServer = async (username, projectId, projectData) => {
                    const allProjects = { ...projects, [projectId]: projectData };
                    const response = await fetch(`${API_BASE_URL}/${username}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(allProjects)
                    });
                    if (!response.ok) throw new Error('Ï†ÄÏû• Ïã§Ìå®');
                };

                const loadFromServer = async (username) => {
                    const response = await fetch(`${API_BASE_URL}/${username}`);
                    if (!response.ok) {
                        if (response.status === 404) return null;
                        throw new Error('Î°úÎìú Ïã§Ìå®');
                    }
                    const data = await response.json();
                    return data.projects || {};
                };

                const loadUserProjects = async () => {
                    let username = usernameInput.value.trim();
                    if (!username) {
                        return;
                    }
                    currentUser.value = username;
                    const loadedProjects = await loadFromServer(username);
                    
                    if (loadedProjects && Object.keys(loadedProjects).length > 0) {
                        for (const key in projects) {
                            delete projects[key];
                        }
                        Object.assign(projects, loadedProjects);
                        const firstProjectId = Object.keys(loadedProjects)[0];
                        selectedProject.value = firstProjectId;
                    } 
                };

                const logout = () => {
                    if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        location.reload();
                    }
                };

                const projectAddModal = () => {
                    if (!currentUser.value) {
                        return;
                    }
                    currentEditingProjectId.value = null;
                    isProjectModalOpen.value = true;
                };

                const projectEditModal = (id) => {
                    currentEditingProjectId.value = id;
                    isProjectModalOpen.value = true;
                };

                const deleteProject = (id) => {
                    if (confirm('Ïù¥ ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        delete projects[id];
                        if (selectedProject.value === id) {
                            selectedProject.value = null;
                        }
                    }
                };

                const updateProject = async (projectData) => {
                    if (!currentUser.value || !selectedProject.value) {
                        return;
                    }
                    Object.assign(projects[selectedProject.value], projectData);
                    await saveProjectToServer(currentUser.value, selectedProject.value, projects[selectedProject.value]);
                };

                const saveProject = async (projectData) => {
                    if (!currentUser.value) {
                        return;
                    }
                    
                    let projectId;
                    if (currentEditingProjectId.value) {
                        projectId = currentEditingProjectId.value;
                        Object.assign(projects[projectId], projectData);
                    } else {
                        projectId = 'p' + Date.now();
                        projects[projectId] = { ...projectData };
                    }
                    
                    await saveProjectToServer(currentUser.value, projectId, projects[projectId]);
                    closeModal();
                };

                const closeModal = () => {
                    isProjectModalOpen.value = false;
                    currentEditingProjectId.value = null;
                };

                return {
                    projects,
                    selectedProject,
                    currentUser,
                    usernameInput,
                    isProjectModalOpen,
                    currentEditingProjectId,
                    editingProject,
                    canvasStyle,
                    totalProjectCount,
                    loadUserProjects,
                    projectAddModal,
                    projectEditModal,
                    deleteProject,
                    updateProject,
                    saveProject,
                    closeModal,
                    logout,
                    projectClick
                };
            }
        });

        app.mount('#app');
    </script>
</body>

</html>
